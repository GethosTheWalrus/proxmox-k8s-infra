stages:
  - validate
  - approval
  - apply

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - state/*

.base-terraform:
  image:
    name: registry.gitlab.com/gitlab-org/terraform-images/stable:latest
  variables:
    TF_ADDRESS: http://git.home/projects/5/terraform/state/k8s

tf-fmt:
  stage: validate
  extends: .base-terraform
  script:
    - terraform fmt -check -recursive

approve/deploy:
  stage: approval
  script:
    - echo "Applying plan!"
  rules:
    - if: $CI_COMMIT_BRANCH
      when: manual

apply:
  stage: apply
  extends: .base-terraform
  script:
    - gitlab-terraform apply
  dependencies:
    - approve/deploy
  allow_failure: false
